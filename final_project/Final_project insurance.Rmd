---
title: "Predicting insurance purchase for Indian farmers"
graphics: yes
output:
  word_document:
    toc: yes
    toc_depth: '4'
  pdf_document:
    toc: yes
    toc_depth: '4'
  html_document:
    code_folding: show
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 4
    toc_float: yes
subtitle: STAT 471/571/701, Fall 2018
header-includes:
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyfoot[CO,CE]{}
- \fancyfoot[LE,RO]{\thepage}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      tidy = TRUE, fig.width = 7, fig.height = 4,
                      fig.align='left', dev = 'pdf')
if(!require("pacman")) install.packages("pacman")
if(!require("pROC")) install.packages("pROC")
pacman::p_load(dplyr, ggplot2, glmnet, car, corrplot)
library(pROC)
```



# Introduction

## Background


## Goal of the study


## The data



### Characteristics of the Data Set


### Description of variables


# Research approach


## Analyses of dataset


```{r}
data.main<- read.csv("insurance_dataset.csv", header = T)

str(data.main)

#find out if dataset has missing values
sum(is.na(data.main))

#analyze which columns,rows have missing values


#it seems there are empty rows at the bottom of the dataset, so these can simply be deleted
data <- na.omit(data.main) #there are empty rows in the dataset, to omit these data 
str(data)
View (data)

```


## EDA on variables in the dataset 

```{r}


#RESPONSE VARIABLE - convert the response variable to a factor and rename it to "policy.output" for convenience
data <- data %>% rename(policy.output = No..of.mobile.home.policies ) 
data <- data %>% mutate(policy.output = as.factor(policy.output))
ggplot(data,aes(x=policy.output)) + geom_bar() + labs(x="No. of mobile home policies ")
#There is about a 2/3rd split in response variable i.e. 1/3rd of the data population has a mobile policy


#to determine which variables should be considered ion our model, we plot each variable and see if there is 1) enough variability within the variable, and 2) a hint of correlation with our output variable (policy.output)

# Var 44 (pr_num) is ignored for this analysis as it is an accounting or idenitification variable, and therefore logically cannot have any predictive power


# ANALYZING VARIABLE 1&2 - The Customer types
head(data$Customer.main.type)
head(data$Customer.Subtype)
#These varaibles are clearly factors, which have been found from previous demographic and psychographic analysis of the customers. They should be converted to factors
data$Customer.main.type <- as.factor(data$Customer.main.type)
data$Customer.Subtype <- as.factor(data$Customer.Subtype)
#Plot these varaibles, check if they have any correlation with the output varaible, and check if there is significant internal variation
plot<-ggplot(data,aes(x=Customer.main.type, fill= policy.output))
plot<-plot + geom_bar()
plot<-plot + labs(x="Customer Main Type")
plot
#There is reasonable variation, all levels are represented. This varaible should be left as is
plot<-ggplot(data,aes(x=Customer.Subtype, fill= policy.output))
plot<-plot + geom_bar()
plot
#There is reasonable variation, all levels are represented. This varaible should be left as is

#Analyzing var 3- number of houses
head(data$Number.of.houses)
#These are integer values
plot<-ggplot(data,aes(x=Number.of.houses, fill= policy.output))
plot<-plot + geom_bar()
plot
#Data is highly skewed, and could benefit from a log transformation, but since the number is so low (10), we can ignore the transformation to reduce complexity

#Analyzing var 4- avg size household
head(data$Avg.size.household)
#These are integer values
plot<-ggplot(data,aes(x=Avg.size.household, fill= policy.output))
plot<-plot + geom_bar()
plot
#Data is normal and has significant variation, leave the variable as is

#Analyzing var 5- avg age
head(data$Avg.age)
#These are factors as per the table. It may help in interpretation to rename the variable's levels. It is misleading, in this case, for the age to be 1,2,3.. as it may be interpreted as integers. So we name the levels to the meaning of each factor (in appendix)
data$Avg.age <- factor(data$Avg.age,
                     levels=c(1:6),
                     labels=c("20-30 years",
                              "30-40 years",
                              "40-50 years",
                              "50-60 years",
                              "60-70 years",
                              "70-80 years"))
#PLOT data
plot<-ggplot(data,aes(x=Avg.age, fill= policy.output))
plot<-plot + geom_bar()
plot
#Data is normal and has significant variation, and is not interpretable. We can move on

data$Roman.catholic
data$Income..123.000

#Variable 6-41 are variables with similar factor values (% of society). All of them are clearly factors, and the factor levels should be recoded to the %of society values for interpretability
for (i in which(colnames(data)=="Roman.catholic"):which(colnames(data)=="Income..123.000")){
  data[,i] <- factor(data[,i],
                   levels=c(0:9),
                   labels=c("0%",
                            "1-10%",
                            "11-23%",
                            "24-36%",
                            "37-49%",
                            "50-62%",
                            "63-75%",
                            "76-88%",
                            "89-99%",
                            "100%"))
}
str(data)


#If any entry was not in the 0-9 range, it must be coded incorrectly, and would appear as NA now. Let us check if there are any NAs
sum(is.na(data))
#No NA varaibles, therefore all the data till now was coded properly 

#Varaibles 6-9 are all linked to religion, let us interpret them together
JUST.FOR.PLOT <- rbind(data.frame(dataset="Roman catholic", obs=data$Roman.catholic),
            data.frame(dataset="Protestant", obs=data$Protestant),
            data.frame(dataset="Other ", obs=data$Other.religion),
            data.frame(dataset="None", obs=data$No.religion))
JUST.FOR.PLOT$dataset <- as.factor(JUST.FOR.PLOT$dataset)
ggplot(JUST.FOR.PLOT, aes(x=obs, fill=dataset)) +geom_bar() + 
ggtitle("Histogram with distribution of Religion")
#We can see there is significant variation between each type of religion, and therefore these varaibles should be left as is  

#Variables 10-13 are all linked to Marital status, let us interpret them together
JUST.FOR.PLOT <- rbind(data.frame(dataset="Married", obs=data$Married),
            data.frame(dataset="Living together", obs=data$Living.together),
            data.frame(dataset="Other relation ", obs=data$Other.relation),
            data.frame(dataset="Singles", obs=data$Singles))
JUST.FOR.PLOT$dataset <- as.factor(JUST.FOR.PLOT$dataset)
ggplot(JUST.FOR.PLOT, aes(x=obs, fill=dataset)) +geom_bar() + 
ggtitle("Histogram with distribution of Marital status")
#We can see there is significant variation between each type of marital status, and therefore these varaibles should be left as is  



```




## Split dataset into test and training 


```{r}



#Let us do a correlation plot to check if any two variables are highly correlated
corrplot(cor(data.main %>% select(time_in_hospital, num_lab_procedures, num_procedures, num_medications, number_outpatient, number_emergency, number_inpatient, number_diagnoses)))
#Only number of medications and time in hospital are  correlated, which makes logical sense as a patient with more time in hospital is likely to have got more treatment, so we can keep both variables in consideration


#split the training and test data sets, so we can proceed with analysis on training data set, and check our accuracy on the test data set
N <- length(data$pr_num)
set.seed(10)
index.train <- sample(N, 0.8*N)
data.train <- data[index.train,] #dim(data.train)
data.test <- data[-index.train,] 
dim(data.train)
dim(data.test)
str(data.train)

```

## Model Building
